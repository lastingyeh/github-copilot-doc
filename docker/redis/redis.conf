# Redis 配置檔案
# 針對 TinyURL 服務優化的 Redis 設定

# ===========================================
# 基本配置
# ===========================================

# 綁定所有介面（容器環境安全）
bind 0.0.0.0

# 預設端口
port 6379

# 關閉保護模式（在容器環境中）
protected-mode no

# 設定 TCP keepalive
tcp-keepalive 300

# ===========================================
# 記憶體管理
# ===========================================

# 最大記憶體使用量（根據容器資源調整）
maxmemory 256mb

# 記憶體淘汰策略（LRU - 最近最少使用）
maxmemory-policy allkeys-lru

# ===========================================
# 持久化設定
# ===========================================

# 啟用 AOF 持久化
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec

# RDB 快照設定
save 900 1
save 300 10
save 60 10000

# RDB 檔案名稱
dbfilename dump.rdb

# 工作目錄
dir /data

# ===========================================
# 網路與連線
# ===========================================

# 客戶端閒置超時（秒）
timeout 300

# 最大客戶端連線數
maxclients 10000

# TCP backlog
tcp-backlog 511

# ===========================================
# 慢查詢日誌
# ===========================================

# 慢查詢閾值（微秒）
slowlog-log-slower-than 10000

# 慢查詢日誌最大條數
slowlog-max-len 128

# ===========================================
# 安全設定
# ===========================================

# 重新命名危險指令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""

# ===========================================
# 客戶端輸出緩衝區限制
# ===========================================

# 一般客戶端
client-output-buffer-limit normal 0 0 0

# 複製客戶端
client-output-buffer-limit replica 256mb 64mb 60

# 發布訂閱客戶端
client-output-buffer-limit pubsub 32mb 8mb 60

# ===========================================
# 其他優化設定
# ===========================================

# 啟用 lazy free
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# 雜湊表優化
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# 列表優化
list-max-ziplist-size -2
list-compress-depth 0

# 集合優化
set-max-intset-entries 512

# 有序集合優化
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# 禁用某些命令以提升安全性
# rename-command SHUTDOWN SHUTDOWN_SECRET
# rename-command DEBUG ""